---
title: "Vignette"
author: "Rachel Fellman"
date: "2023-10-02"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
This document is intended to explain how to contact and API and query, parse, and return readable data from an API. I will be accessing the earthquake api from the USGS. There is no API key required to access this API.

I am interested in investigating earthquakes of varying magnitudes and regions. Do different regions have higher magnitude earthquakes than others? Are most earthquakes within a certain magnitude range? Are there different measurement methods that are more common for measuring earthquake magnitude?

# Required Packages
I used the following packages to create the vignette:
  * `httr`: for accessing the API
  * `jsonlite`: to convert API data into a data frame
  * `tidyverse`: used for piping, plotting, and other basic functions


I first started by loading the necessary packages into rstudio. 

```{r}
library(tidyverse)
library(jsonlite)
library(httr)
```


# Functions to Query Endpoints

Before creating functions to query specific endpoints of the API, I will create a function to assign labels to each variable, making them easier to understand. The input for this function is a singular data frame. 

```{r}
label <- function(x){
  x <- apply_labels(x,
                    mag = 'Magnitude')
}
```

The first function `query.data` will allow the user to chose a minimum and maximum magnitude, maximum gap, and event type.  Magnitude values can range from -1 to 10. The gap is the azimuthal gap between stations. The smaller the gap, the more accurate the calculations of the position of the earthquake are. This value can be between 0.0 and 180.0 degrees. The event type will have a default value of earthquake but can also take on any of the following values:

  *accidental explosion
  *acoustic noise
  *acoustic_noise
  *anthropogenic_event
  *building collapse
  *chemical explosion
  *chemical_explosion
  *collapse
  *experimental explosion
  *explosion
  *ice quake
  *induced or triggered event
  *industrial explosion
  *landslide
  *meteor
  *meteorite
  *mine collapse
  *mine_collapse
  *mining explosion
  *mining_explosion
  *not reported
  *not_reported
  *nuclear explosion
  *nuclear_explosion
  *other
  *other_event
  *quarry
  *quarry_blast
  *rockslide
  *rock_burst
  *snow_avalanche
  *sonic boom
  *sonicboom
  *sonic_boom
  *train crash
  *volcanic eruption
  *volcanic explosion

```{r}
query.data <- function(min.mag = 0, max.mag = 10, max.gap = 90.0, event.type = "earthquake"){
  #make the api url to query the endpoints specified in the function inputs
  my.url <- paste0("https://earthquake.usgs.gov/fdsnws/event/1/query?format=geojson",
                "&minmagnitude=", min.mag,
                "&maxmagnitude=", max.mag,
                "&maxgap=",max.gap,
                "&eventtype=", event.type)
  
  #get data from api using url created above
  quake.data <- fromJSON(my.url)
  
  #select specific columns
  quake.data.col<- quake.data$features$properties %>% 
    select('mag','place','time','sig','net','code','ids','dmin','nst','rms','gap','magType','type')
  
  #return a dataframe of earthquake data
  return(as_tibble(quake.data.col))
}
```

The next function `eq.location` will allow the user to specify a latitude, longitude and maximum radius in km. This function will return data on earthquakes that occurred within the specified radius of the chosen longitude and latitude. The only default value will be the maximum radius set to 100 km. Latitude values can be from -90 to 90 degrees and longitude values can span from -180 to 180 degrees. 

```{r}
eq.location <- function(latitude, longitude, max.radius = 100){
  #create URL for user specified depth
  my.url <- paste0("https://earthquake.usgs.gov/fdsnws/event/1/query?format=geojson&eventtype=earthquake",
                "&latitude=", latitude,
                "&longitude=", longitude,
                "&maxradiuskm=", max.radius)
  
  #get data from api with url created above
  quake.data <- fromJSON(my.url)
  
  #select specific columns .
quake.data.col<- quake.data$features$properties %>% 
    select('mag','place','time','sig','net','code','ids','dmin','nst','rms','gap','magType','type')
   return(as_tibble(quake.data.col))
}
```

# Call API Functions

I will pull data from the API using my `query.data` function. I will set the minimum magnitude to 0 and the maximum to 4, to look at smaller earthquakes. (Magnitude is a measure of the size of an earthquake at its source). I will set the maximum gap to 180 degrees since the USGS states that earthquake locations with a gap larger than 180 degrees tend to have larger location and depth uncertainties. I will not change the settings for event type since I am primarily interested only in events classified as earthquakes.

```{r}
earthquakes.low <- query.data(min.mag = 0, max.mag = 4, max.gap = 180)
earthquakes.low
```

I will again pull data from the API using the `query.data` function but changing the magnitude settings to be between 4 and 10. All other inputs will remain the same as above. 

```{r}
earthquakes.high <- query.data(min.mag = 4, max.mag = 10, max.gap = 180)
earthquakes.high
```

I will also pull data from my `eq.location` function. I will specify the latitude 19.74 and longitude -155.84. This is the latitude and longitude for Hawaii. I will increase the maximum radius to 200km. I am choosing Hawaii for this function since it is a location in the US known for having siesmic acitvity. 

I will also create a data frame for all earthquakes magnitude 0 to 10.
```{r}
earthquakes.all <- query.data(min.mag = -1, max.mag = 10, max.gap = 180)
```


```{r}
eq.Hawaii <- eq.location(latitude = 19.74, longitude = -155.84, max.radius = 200)
eq.Hawaii
```

# Contingency Tables

Next I will examine the data pulled from the API with my functions. Using `earthquakes.low` and `earthquakes.high`, I will create contingency tables fo magType and net. magType tells us the method used to calculate the magnitude for the event. This is of interest because different methods could produce different results. The net variable provides the ID for the network that is the main source of information for a given earthquake. The networks include places such as AK: ALaska Earthquake Center, HV: Hawaii Vocano Observatory, etc. The reason I am creating a 2 way table with magType and net is to see if different networks use a certain method more.

```{r}
table(earthquakes.low$magType, earthquakes.low$net)
```

When looking at the lower magnitude earthquakes it seems like the ml method is used most frequently. The ML method is the original magnitude scale defined Richter and Gutenberg. It makes sense that this is a commonly used method by many stations for low magnitude earthquakes since the ML scale is most accurate for earthquakes with a magnitude less than 4. The nc network (California Integrated Seismic Network) also has a high frequency for the md method. This method is also useful for lower magnitude earthquakes and is sometimes the only available method for very small seismic events. 

```{r}
table(earthquakes.high$magType, earthquakes.high$net)
```

My first observation is that there are fewer networks that measure high magnitude earthquakes. This may be because there are fewer occurrences of high magnitude earthquakes. The most commonly used method by the us network (USGS National Earthquake Information Center) Is the mb method. This makes sense since the mb method is useful for earthquakes of magnitude 4 to 6.5.


# Numerical Summaries Across Categorical Variables

I am interested to look at the average, median, and standard deviation low magnitude and high magnitude earthquakes measured by each network. The reason I am including both the median and mean is to account for outliers affecting the average.

```{r}
earthquakes.low %>% 
  group_by(net) %>% 
  summarize(min = min(mag), max = max(mag), avg = mean(mag), med = median(mag), sd= sd(mag))
```
The highest average earthquakes had data collected by the Puerto Rico Seismic Network (pr) and the Center for Earthquake Research and Information (SE). I didn't know that Puerto Rico was a location that had earthquakes so this is a surprise to me. 

```{r}
earthquakes.high %>% 
  group_by(net) %>% 
  summarize(min = min(mag), max = max(mag), avg = mean(mag), med = median(mag), sd= sd(mag))
```

The maximum earthquake measured was a magnitude 6.8 much higher than the averages for all networks which stay between 4 and 5. 

I am curious where the 6.8 magnitude earthquake was so instead of just summarizing I will use the `filter` function and explore further.

```{r}
earthquakes.high %>% 
  filter(mag == 6.8)
```
The highest magnitude earthquake in the data we pulled from the API was in Al Haouz, Morocco.

Next I want to look at measures of center and spread for the magnitude of earthquakes in Hawaii across the magType variable.  
```{r}
eq.Hawaii %>% 
  group_by(magType) %>% 
  summarize(min = min(mag), max = max(mag), avg = mean(mag), med = mean(mag), sd = sd(mag))
```
This shows that the minimum magnitude earthquake measuring .13 was measured using the md method while the smallest earthquake measured using the ml method was a magnitude 1. This makes sense since the md method is better for measuring very small events.

# Plots

First I will create a bar plot of the networks and magtypes for the lower magnitue data. Since the most used measurement methods for low magnitude earthquakes are md and ml I will first filter to include only those methods. This will just give us a better visualization of which networks use which methods more frequently.

```{r}
#filter magType variable
method.earthquake.low <- earthquakes.low %>% 
  filter(magType == "md" | magType == "ml")

#create base plot
g<- ggplot(data = method.earthquake.low, aes(x=magType))
#add bar plot with net as the factor
g + geom_bar(aes(fill = as.factor(net)), position = "dodge") +
#add labels/ titles
  labs(x = "Measurement Method", title = "Magnitude Measurement Methods Across Networks for Earthquakes Under Magnitude 4") + 
  scale_fill_discrete(name= "Network", labels = c("Alaska Volcano Observatory", "California Integrated Seismic Network: Southern California", "Hawaii Volcano Observatory", "Montana Bureau of Mines and Geology", "California Integrated Seismic Network: Northern Californa", "New Madrid Seismic Network","Oklahoma Seismic Network", "Puerto Rico Seismic Network","Center for Earthquake Research and Information", "USGS National Earthquake Information Center","Texas Seismological Network", "University of Utah Seismograph Stations", "Pacific Northwest Seismic Network")) +
#adjust plot sizing
  theme(legend.title = element_text(size=7), legend.text = element_text(size=6), title = element_text(size = 10), plot.margin = margin(.1,.1,.1,.1,"cm"))
```

From this bar graph it is easy to see that the California Integrated Seismic network in both Northern and Southern California collect a large amount of earthquake data. However, it is easy to see here that the md method is used most commonly by the Northern California network and the ml method by the Southern California network. This may be due to the typical magnitude of the earthquakes found in each region. 


Next I will create a histogram of the magnitude for the lower magnitude earthquakes. I am interested in the distribution of the earthquakes and if it is skewed in any direction.
```{r}
#create base plot
a <- ggplot(data= earthquakes.low, aes(x = mag))
#add histogram
a + geom_histogram(color = "blue",fill = "darkgrey", size = .6, binwidth = .2, weight = 2) +
#add labels
  labs(x = "Magnitude", title = "Histogram of Earthquake Magnitude for Earthquakes Under Magnitude 4")
  
```

The lower magnitude earthquakes appear to be slightly right skewed, with most earthquakes centering around a magnitude of 1.

It is clear that the lower magnitude earthquake data is skewed, so I am interested in seeing if the data as a whole (not slpit into low and high magnitude) also appears skewed. 
I will use `geom_density` to look at the spread of the data.

```{r}
#create base plot
b<- ggplot(earthquakes.all)
#add boxplot layer
b + geom_density(aes(x= mag), adjust = .5, alpha = .5, fill = "lightblue") +
#add labels/titles
  labs(x = "Magnitude", title= "Kernel Density Plot of Earthquake Magnitudes")

```

When looking at the data as whole, it still appears to be right skewed, meaning that the majority of earthquakes are smaller/have a lower magnitude. However we can see that there are also quite a few earthquakes that measure around a magnitude of 4.5, as the density plot displays a local maximum there.


Next I will compare 2 numerical variables `mag` and `sig`. `sig` is a number that signifies the significance of the seismic event. While the calculation of this number does take into account the magnitude, it also includes other factors such as intensity, felt reports, and estimated impact. While I would guess that there would be a positive relationship between the two variables, this graph will help with our exploratory data analysis so we can find out. 

```{r}
c<- ggplot(earthquakes.all, )
```

